#include "PgmEditor.h"


void PgmEditor::init()
{
	FileEditor::init();

	const int DEFAULT_MAX_COLOUR_VALUE = 255;

	this->width = 0;
	this->height = 0;
	this->maxColourValue = DEFAULT_MAX_COLOUR_VALUE;
}

PgmEditor::PgmEditor()
{
	this->init();
}

PgmEditor::PgmEditor(const char * fileName)
{
	this->init();
	this->open(fileName);
}

PgmEditor::PgmEditor(const unsigned int width, const unsigned int height, unsigned int maxColourValue)
{
	this->fill(width, height, maxColourValue);
}

void PgmEditor::read(const char * fileName)
{
	std::ifstream in;
	this->openReadFile(in, fileName);

	if (!in.is_open())
	{
		std::cout << "# Unable to open " << fileName << "." << std::endl;
	}
	else
	{
		this->readHeader(in);

		this->sizeInPixels = this->width * this->height;

		this->gray.reserve(this->sizeInPixels);

		this->readPixels(in);
	}

	in.close();
}

void PgmEditor::write(const char * fileName)
{
	std::ofstream out;
	this->openWriteFile(out, fileName);

	if (out.is_open())
	{
		this->addFileFormat(out);
		out << "# Generated by TRIPCO\n";

		// In order to match the NetPBM standarts
		out << this->width << " " << this->height << "\n";

		out << this->maxColourValue << "\n";

		this->writePixels(out);
	}
	else
	{
		std::cout << "# Unable to open " << fileName << " for changes." << std::endl;
	}

	out.close();
}

void PgmEditor::readHeader(std::ifstream & in)
{
	const int NUMBER_OF_SPECIFICATIONS = 3;
	std::string line;

	std::getline(in, line);
	std::stringstream stream(line);

	std::string format;
	stream >> format;

	if (!this->isValidExtension(format))
	{
		std::cout << "# Unrecognized file format." << std::endl;
		return;
	}

	// Array to hold specifications
	unsigned int specs[NUMBER_OF_SPECIFICATIONS] = {};
	unsigned int i = 0;

	while (true)
	{
		while (!stream.eof())
		{
			stream >> specs[i++];
		}

		if (i == NUMBER_OF_SPECIFICATIONS) { break; }

		std::getline(in, line);

		// Loop while it is a comment or an empty line
		while (line[0] == '#' || line.empty())
		{
			std::getline(in, line);
		}

		// Reset stream
		stream.str(std::string());
		stream.clear();
		stream.str(line);
	}

	// Finally save data
	this->width = specs[0];
	this->height = specs[1];
	this->maxColourValue = specs[2];
}

void PgmEditor::fill(const unsigned int width, const unsigned int height, unsigned int maxColourValue)
{
	this->init();

	this->width = width;
	this->height = height;

	this->numRows = this->height;
	this->numCols = this->width;

	this->sizeInPixels = this->height * this->width;

	this->maxColourValue = maxColourValue;

	// fill gray container with 0's
	this->gray.resize(this->sizeInPixels);

	// Setting file state to being opened
	this->isOpen = true;
}

unsigned int PgmEditor::getMaxColourValue() const
{
	return this->maxColourValue;
}

unsigned int PgmEditor::getAvgColourValuePerPixel(unsigned int pos) const
{
	try
	{
		return (unsigned int)this->gray.at(pos);
	}
	catch (const std::exception& ex)
	{
		std::cout << ex.what() << std::endl;
	}
	
}